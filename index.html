<html>
<head>
<title>MPEG-TS Websocket demo</title>
</head>
<body>
<h1>MPEG-TS Websocket demo</h1>
<div>
    <button id="starter">Connect</button>
</div>
<video id="livestream" width="640" height="360"></video>
<script>
const mime = 'video/mp4; codecs="avc1.64001E, mp4a.40.2"';
const mediaSource = new MediaSource();
const video = document.getElementById('livestream');

let sourceBuffer = null;
const queue = [];

function initMediaSource() {
  sourceBuffer = mediaSource.addSourceBuffer(mime);
  sourceBuffer.mode = 'sequence';
  sourceBuffer.addEventListener('updateend', sendQueueToBuffer);
  video.play();
}

function sendQueueToBuffer() {
  if (queue.length > 0 && !sourceBuffer.updating) {
    const chunk = queue.shift();
    sourceBuffer.appendBuffer(chunk);
  }
}

function playFromSocket() {
  mediaSource.addEventListener("sourceopen", initMediaSource);
  video.src = URL.createObjectURL(mediaSource);
  const websocket = new WebSocket('ws://localhost:8000');
  websocket.binaryType = 'arraybuffer';
  websocket.addEventListener('message', function(e) {
    queue.push(e.data);
    sendQueueToBuffer();
  }, false);
}

const starterButton = document.getElementById('starter');
starterButton.addEventListener('click', playFromSocket);
</script>
</body>
</html>
